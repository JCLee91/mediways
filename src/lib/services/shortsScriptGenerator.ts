import OpenAI from 'openai';

// ì‡¼ì¸  ì „ìš© ê²½ëŸ‰í™” ì˜ë£Œë²• í”„ë¡¬í”„íŠ¸ (24ì´ˆ ì˜ìƒì— ë§ì¶¤)
const shortsMedialLawPrompt = `
ã€ì˜ë£Œê´‘ê³  ì¤€ìˆ˜ - ì‡¼ì¸  ë²„ì „ã€‘

â›” ê¸ˆì§€:
- ì™„ì¹˜, 100%, ë³´ì¥, ìµœê³ , ìµœì´ˆ
- í™˜ì í›„ê¸°, ì „í›„ ì‚¬ì§„, ê°€ê²©

âœ… ìì—°ìŠ¤ëŸ½ê²Œ 1íšŒë§Œ í¬í•¨:
- ëŒ€ë³¸ ë§ˆì§€ë§‰ì— "ê°œì¸ì°¨ê°€ ìˆì„ ìˆ˜ ìˆì–´ìš”" ë˜ëŠ” "ì „ë¬¸ ìƒë‹´ ì¶”ì²œí•´ìš”" ì¤‘ íƒ1
- ê³¼ë„í•œ ë©´ì±… ì¡°í•­ ë°˜ë³µ ê¸ˆì§€ (ì‡¼ì¸ ëŠ” 24ì´ˆë¼ 1íšŒë©´ ì¶©ë¶„)

ğŸ“ ì–´íˆ¬:
- ë‹¨ì • ê¸ˆì§€ (~ì…ë‹ˆë‹¤ X â†’ ~í•  ìˆ˜ ìˆì–´ìš” O)
- ìì—°ìŠ¤ëŸ½ê³  ë¹ ë¥¸ ë§íˆ¬ ìœ ì§€
`;

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// íƒ€ì… ì •ì˜
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

/** 1ë‹¨ê³„: ê¸°íš ê²°ê³¼ */
interface ShortsPlan {
  procedureName: string;        // ì‹œìˆ /ì§ˆí™˜ëª…
  keywords: string[];           // í•µì‹¬ í‚¤ì›Œë“œ 3ê°œ
  surprisingFact: string;       // ê°€ì¥ ë†€ë¼ìš´ ì •ë³´
  painPoint: string;            // ê°€ì¥ ê³µê°ë˜ëŠ” ê³ ë¯¼
  keyNumbers: string;           // í•µì‹¬ ìˆ˜ì¹˜/ìˆ«ì
  hookType: string;             // ì„ íƒëœ í›… ìœ í˜• (ì§ˆë¬¸í˜•/ì¶©ê²©í˜•/ìˆ«ìí˜•/ì†ì‹¤í˜•/ë°˜ì „í˜•)
  hookSentence: string;         // í›… ë¬¸ì¥
  clipOutlines: {               // 3í´ë¦½ ê°œìš”
    hook: string;               // í´ë¦½1: í›… ê°œìš”
    info: string;               // í´ë¦½2: ì •ë³´ ê°œìš”
    cta: string;                // í´ë¦½3: CTA ê°œìš”
  };
}

/** 2ë‹¨ê³„: ëŒ€ë³¸ ê²°ê³¼ */
interface ShortsScriptDraft {
  shortsTitle: string;
  summary: string;
  segments: {
    title: string;
    content: string;
    order: number;
  }[];
}

/** 3ë‹¨ê³„: ìµœì¢… ê²°ê³¼ (videoPrompt í¬í•¨) */
interface ShortSegment {
  title: string;
  content: string;
  order: number;
  videoPrompt: string;
}

interface ShortsScript {
  shortsTitle: string;
  summary: string;
  segments: ShortSegment[];
  totalDuration: number;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ì„œë¹„ìŠ¤ í´ë˜ìŠ¤
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

export class ShortsScriptGeneratorService {
  private openai: OpenAI;

  constructor(apiKey: string) {
    this.openai = new OpenAI({ apiKey });
  }

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // ë©”ì¸ í•¨ìˆ˜: 3ë‹¨ê³„ ìˆœì°¨ ì‹¤í–‰
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  async generateScript(
    title: string,
    content: string,
    onProgress?: (stage: number) => Promise<void>
  ): Promise<ShortsScript> {
    const truncatedContent = content.slice(0, 8000);

    console.log('[ShortsScript] 1ë‹¨ê³„: ê¸°íš ìƒì„± ì‹œì‘...');
    console.log(`[ShortsDebug] Input Title: ${title}`);
    console.log(`[ShortsDebug] Input Content (first 200 chars): ${truncatedContent.slice(0, 200)}...`);

    const plan = await this.generatePlan(title, truncatedContent);
    console.log('[ShortsScript] 1ë‹¨ê³„ ì™„ë£Œ:', plan.hookType, plan.hookSentence);
    console.log(`[ShortsDebug] Generated Plan:`, JSON.stringify(plan, null, 2));

    // 2ë‹¨ê³„ ì‹œì‘ ì•Œë¦¼
    if (onProgress) await onProgress(1);

    console.log('[ShortsScript] 2ë‹¨ê³„: ëŒ€ë³¸ ìƒì„± ì‹œì‘...');
    const scriptDraft = await this.generateScriptDraft(title, truncatedContent, plan);
    
    // ìš”ì•½ ë‚´ìš© ì•ˆì „ì¥ì¹˜
    if (!scriptDraft.summary) {
      scriptDraft.summary = `${plan.procedureName}ì— ëŒ€í•œ í•µì‹¬ ìš”ì•½ì…ë‹ˆë‹¤.`;
    }
    
    console.log('[ShortsScript] 2ë‹¨ê³„ ì™„ë£Œ:', scriptDraft.shortsTitle);
    console.log(`[ShortsDebug] Generated Script Draft:`, JSON.stringify(scriptDraft, null, 2));

    // 3ë‹¨ê³„ ì‹œì‘ ì•Œë¦¼
    if (onProgress) await onProgress(2);

    console.log('[ShortsScript] 3ë‹¨ê³„: ì˜ìƒ í”„ë¡¬í”„íŠ¸ ìƒì„± ì‹œì‘...');
    const finalScript = await this.generateVideoPrompts(plan, scriptDraft);
    console.log('[ShortsScript] 3ë‹¨ê³„ ì™„ë£Œ. ì „ì²´ ì™„ë£Œ!');
    console.log(`[ShortsDebug] Final Script with Prompts:`, JSON.stringify(finalScript, null, 2));

    return finalScript;
  }

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // 1ë‹¨ê³„: ê¸°íš (ë¸”ë¡œê·¸ ë¶„ì„ â†’ í›…/êµ¬ì¡° ê¸°íš)
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  private async generatePlan(title: string, content: string): Promise<ShortsPlan> {
    const prompt = `ë‹¹ì‹ ì€ 100ë§Œ ë·° ë°”ì´ëŸ´ ì‡¼ì¸  ì „ë¬¸ ê¸°íšìì…ë‹ˆë‹¤.

${shortsMedialLawPrompt}

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
ã€ë¸”ë¡œê·¸ ë¶„ì„ ëŒ€ìƒã€‘
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

ì œëª©: ${title}

ë³¸ë¬¸:
${content}

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
ã€ë¶„ì„ ë° ê¸°íš ì§€ì‹œã€‘
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

ìœ„ ë¸”ë¡œê·¸ë¥¼ ë¶„ì„í•˜ì—¬ ë°”ì´ëŸ´ ì‡¼ì¸  ê¸°íšì•ˆì„ ì‘ì„±í•˜ì„¸ìš”.

1. ë¸”ë¡œê·¸ì—ì„œ ì¶”ì¶œ:
   - ì‹œìˆ /ì§ˆí™˜ëª… (ì˜ˆ: ë¼ì‹, ë°±ë‚´ì¥, ë³´í†¡ìŠ¤)
   - í•µì‹¬ í‚¤ì›Œë“œ 3ê°œ (ë°˜ë³µë˜ëŠ” ë‹¨ì–´)
   - ê°€ì¥ ë†€ë¼ìš´ ì •ë³´ (ì‹œì²­ìê°€ "ì–´?" í•  ë‚´ìš©)
   - ê°€ì¥ ê³µê°ë˜ëŠ” ê³ ë¯¼ (íƒ€ê²Ÿì˜ Pain Point)
   - í•µì‹¬ ìˆ˜ì¹˜/ìˆ«ì (ì‹œê°„, ë¹„ìš©, íš¨ê³¼ ë“±)

2. í›…(Hook) ì„ íƒ - â˜…ê°€ì¥ ì¤‘ìš”â˜…
   ì²« 1.7ì´ˆ ì•ˆì— ìŠ¤ì™€ì´í”„ ê²°ì •! ì•„ë˜ 5ê°€ì§€ ì¤‘ ê°€ì¥ íš¨ê³¼ì ì¸ ê²ƒ ì„ íƒ:

   - ì§ˆë¬¸í˜•: "[ì‹œìˆ ëª…] ì•„ì§ë„ ëª¨ë¥´ì„¸ìš”?"
   - ì¶©ê²©í˜•: "ì˜ì‚¬ë„ ë§ ì•ˆ í•´ì£¼ëŠ” [ì§ˆí™˜] ì§„ì‹¤"
   - ìˆ«ìí˜•: "[ìˆ«ì]ë¶„ ë§Œì— ëë‚˜ëŠ” [ì‹œìˆ ëª…]"
   - ì†ì‹¤í˜•: "[ì§ˆí™˜] ë°©ì¹˜í•˜ë©´ ì´ë ‡ê²Œ ë©ë‹ˆë‹¤"
   - ë°˜ì „í˜•: "[ì‹œìˆ ëª…] ë¬´ì„­ë‹¤ê³ ìš”? ì‚¬ì‹¤ì€..."

   âŒ ì¼ë°˜ì  í›… ê¸ˆì§€ ("ê±´ê°• ê³ ë¯¼ ìˆìœ¼ì„¸ìš”?" ë“±)
   âœ… ë°˜ë“œì‹œ ë¸”ë¡œê·¸ì˜ êµ¬ì²´ì  ë‚´ìš©/ìˆ˜ì¹˜ í™œìš©!
   âœ… ë¸”ë¡œê·¸ì— ìˆëŠ” ê³ ìœ í•œ ì—í”¼ì†Œë“œë‚˜ êµ¬ì²´ì  ì‚¬ë¡€ê°€ ìˆë‹¤ë©´ ìµœìš°ì„  ë°˜ì˜!

3. 3í´ë¦½ êµ¬ì¡° ê°œìš” (ê° 8ì´ˆ, ì´ 24ì´ˆ):
   - í´ë¦½1 (í›…): 0-3ì´ˆ í›… + 3-8ì´ˆ ê³µê°/ë¬¸ì œ í™•ì¥ (ë¸”ë¡œê·¸ì˜ êµ¬ì²´ì  ìƒí™© ë¬˜ì‚¬)
   - í´ë¦½2 (ì •ë³´): ë¸”ë¡œê·¸ í•µì‹¬ ì •ë³´ 2ê°œ (ì¼ë°˜ì  ì˜í•™ ìƒì‹ë³´ë‹¤ëŠ” ì´ ë³‘ì›ë§Œì˜ íŠ¹ì§•/ì¥ì  ìœ„ì£¼)
   - í´ë¦½3 (CTA): ê¸ì •ì  ê²°ê³¼ + í–‰ë™ ìœ ë„

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
ã€ì¶œë ¥ í˜•ì‹ (JSON)ã€‘
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

{
  "procedureName": "ì‹œìˆ /ì§ˆí™˜ëª…",
  "keywords": ["í‚¤ì›Œë“œ1", "í‚¤ì›Œë“œ2", "í‚¤ì›Œë“œ3"],
  "surprisingFact": "ê°€ì¥ ë†€ë¼ìš´ ì •ë³´ (1ë¬¸ì¥)",
  "painPoint": "ê°€ì¥ ê³µê°ë˜ëŠ” ê³ ë¯¼ (1ë¬¸ì¥)",
  "keyNumbers": "í•µì‹¬ ìˆ˜ì¹˜ (ì˜ˆ: 10ë¶„, 90% ë“±)",
  "hookType": "ì§ˆë¬¸í˜•|ì¶©ê²©í˜•|ìˆ«ìí˜•|ì†ì‹¤í˜•|ë°˜ì „í˜• ì¤‘ í•˜ë‚˜",
  "hookSentence": "ì‹¤ì œ ì‚¬ìš©í•  í›… ë¬¸ì¥ (ë¸”ë¡œê·¸ ë‚´ìš© ê¸°ë°˜)",
  "clipOutlines": {
    "hook": "í´ë¦½1 ê°œìš”: í›… + ê³µê° í¬ì¸íŠ¸",
    "info": "í´ë¦½2 ê°œìš”: ì „ë‹¬í•  í•µì‹¬ ì •ë³´ 2ê°œ",
    "cta": "í´ë¦½3 ê°œìš”: ê¸°ëŒ€íš¨ê³¼ + í–‰ë™ìœ ë„"
  }
}`;

    const response = await this.callAI(prompt);
    return JSON.parse(response) as ShortsPlan;
  }

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // 2ë‹¨ê³„: ëŒ€ë³¸ ìƒì„± (ê¸°íš â†’ ëŒ€ë³¸)
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  private async generateScriptDraft(
    title: string,
    content: string,
    plan: ShortsPlan
  ): Promise<ShortsScriptDraft> {
    const prompt = `ë‹¹ì‹ ì€ ë°”ì´ëŸ´ ì‡¼ì¸  ëŒ€ë³¸ ì‘ê°€ì…ë‹ˆë‹¤. ê¸°íšì•ˆì„ ë°”íƒ•ìœ¼ë¡œ ëŒ€ë³¸ì„ ì‘ì„±í•©ë‹ˆë‹¤.

${shortsMedialLawPrompt}

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
ã€ê¸°íšì•ˆã€‘
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

ì‹œìˆ /ì§ˆí™˜ëª…: ${plan.procedureName}
í•µì‹¬ í‚¤ì›Œë“œ: ${plan.keywords.join(', ')}
ë†€ë¼ìš´ ì •ë³´: ${plan.surprisingFact}
Pain Point: ${plan.painPoint}
í•µì‹¬ ìˆ˜ì¹˜: ${plan.keyNumbers}

ì„ íƒëœ í›…: ${plan.hookType}
í›… ë¬¸ì¥: "${plan.hookSentence}"

í´ë¦½ êµ¬ì¡°:
- í´ë¦½1 (í›…): ${plan.clipOutlines.hook}
- í´ë¦½2 (ì •ë³´): ${plan.clipOutlines.info}
- í´ë¦½3 (CTA): ${plan.clipOutlines.cta}

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
ã€ì›ë³¸ ë¸”ë¡œê·¸ (ì°¸ê³ ìš©)ã€‘
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

ì œëª©: ${title}
ë‚´ìš© ìš”ì•½: ${content.slice(0, 10000)}...

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
ã€ëŒ€ë³¸ ì‘ì„± ê·œì¹™ã€‘
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

â˜… í•„ìˆ˜ ê·œì¹™:
- ê¸°íšì•ˆì˜ í›… ë¬¸ì¥ì„ ì²« ë¬¸ì¥ìœ¼ë¡œ ì‚¬ìš©
- ì‹œìˆ ëª…/ì§ˆí™˜ëª… "${plan.procedureName}" ë°˜ë“œì‹œ í¬í•¨
- í•µì‹¬ ìˆ˜ì¹˜ "${plan.keyNumbers}" ë°˜ë“œì‹œ í™œìš©
- ë§íˆ¬: ë¹ ë¥´ê³  ë‹¨ì •ì  (~í•´ìš”, ~ì—ìš”)
- ë¬¸ì¥ë‹¹ 10ì ì´ë‚´ (ë¹ ë¥¸ ìë§‰ìš©)

â˜… ì‹œê°„ ë°°ë¶„ (ì´ 24ì´ˆ):
- í´ë¦½1 (0-8ì´ˆ): í›… 3ì´ˆ + ê³µê° í™•ì¥ 5ì´ˆ
- í´ë¦½2 (8-16ì´ˆ): ì •ë³´1 4ì´ˆ + ì •ë³´2 4ì´ˆ
- í´ë¦½3 (16-24ì´ˆ): ê¸°ëŒ€íš¨ê³¼ 4ì´ˆ + CTA 4ì´ˆ

âŒ ê¸ˆì§€:
- ì˜ë£Œë²• ìœ„ë°˜ (ì™„ì¹˜, 100%, í™˜ìí›„ê¸°, ê°€ê²©)
- ë¸”ë¡œê·¸ì— ì—†ëŠ” ë‚´ìš© ì°½ì‘ (ì¼ë°˜ì ì¸ ì˜í•™ ìƒì‹ìœ¼ë¡œ ì±„ìš°ì§€ ë§ ê²ƒ)
- ëŠë¦° ì „ê°œ, ê¸´ ì„¤ëª…
- "ì•ˆë…•í•˜ì„¸ìš”", "ì˜¤ëŠ˜ì€~" ê°™ì€ ì¸ì‚¬ë§ ì ˆëŒ€ ê¸ˆì§€
- ë¸”ë¡œê·¸ì— ì–¸ê¸‰ëœ êµ¬ì²´ì  ìˆ˜ì¹˜ë‚˜ ê³ ìœ  ëª…ì‚¬ê°€ ìˆë‹¤ë©´ ë°˜ë“œì‹œ í¬í•¨í•  ê²ƒ

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
ã€ì¶œë ¥ í˜•ì‹ (JSON)ã€‘
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

{
  "shortsTitle": "ì‡¼ì¸  ì œëª© (15ì ì´ë‚´, ì‹œìˆ ëª… í¬í•¨, í˜¸ê¸°ì‹¬ ìœ ë°œ)",
  "summary": "ë¸”ë¡œê·¸ í•µì‹¬ ìš”ì•½ (ì‹œìˆ ëª… + í•µì‹¬ ì •ë³´ 2-3ê°œ)",
  "segments": [
    {
      "title": "í›…: ${plan.hookType}",
      "content": "[0-3ì´ˆ í›…] [3-8ì´ˆ ê³µê° í™•ì¥] - ê° ë¬¸ì¥ ì§§ê²Œ!",
      "order": 0
    },
    {
      "title": "ì •ë³´: í•µì‹¬ ì „ë‹¬",
      "content": "[8-12ì´ˆ ì •ë³´1] [12-16ì´ˆ ì •ë³´2] - ë¸”ë¡œê·¸ ë‚´ìš© ê¸°ë°˜!",
      "order": 1
    },
    {
      "title": "CTA: í–‰ë™ ìœ ë„",
      "content": "[16-20ì´ˆ ê¸°ëŒ€íš¨ê³¼] [20-24ì´ˆ CTA] - ê¸ì •ì  ë§ˆë¬´ë¦¬!",
      "order": 2
    }
  ]
}`;

    const response = await this.callAI(prompt);
    return JSON.parse(response) as ShortsScriptDraft;
  }

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // 3ë‹¨ê³„: ì˜ìƒ í”„ë¡¬í”„íŠ¸ ìƒì„± (ëŒ€ë³¸ â†’ Grok Imagine í”„ë¡¬í”„íŠ¸)
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  private async generateVideoPrompts(
    plan: ShortsPlan,
    scriptDraft: ShortsScriptDraft
  ): Promise<ShortsScript> {
    const segmentsInfo = scriptDraft.segments
      .map((s, i) => `í´ë¦½${i + 1} (${s.title}): "${s.content}"`)
      .join('\n');

    const prompt = `ë‹¹ì‹ ì€ AI ì˜ìƒ ìƒì„± ì „ë¬¸ê°€ì…ë‹ˆë‹¤. ëŒ€ë³¸ì— ë§ëŠ” Grok Imagine í”„ë¡¬í”„íŠ¸ë¥¼ ì‘ì„±í•©ë‹ˆë‹¤.

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
ã€ëŒ€ë³¸ ì •ë³´ã€‘
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

ì‹œìˆ /ì§ˆí™˜: ${plan.procedureName}
í•µì‹¬ í‚¤ì›Œë“œ: ${plan.keywords.join(', ')}

${segmentsInfo}

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
ã€Grok Imagine í”„ë¡¬í”„íŠ¸ ì‘ì„± ê·œì¹™ - Stable High Qualityã€‘
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

â˜… "ì•ˆì •ì ì´ê³  ì„ ëª…í•œ ê³ í™”ì§ˆ ì˜ìƒ"ì´ í•µì‹¬ì…ë‹ˆë‹¤. ë³µì¡í•œ êµ¬ë„ë‚˜ ê³¼ë„í•œ ì›€ì§ì„ì€ ì˜ìƒì„ ê¸°ê´´í•˜ê²Œ ë§Œë“¤ ìˆ˜ ìˆìŠµë‹ˆë‹¤.

â˜… í™©ê¸ˆ ê³µì‹: Subject + Real Environment + Natural Lighting + Tech Specs + Atmosphere
â˜… 8ì´ˆ í´ë¦½ = 3ì»· (ì•ˆì •ì ì¸ ì¥ë©´ ì „í™˜)
â˜… 600-700ì ì˜ë¬¸ ê¶Œì¥

ã€í•„ìˆ˜ í¬í•¨ ìš”ì†Œ - Clean & Realisticã€‘
1. Tech Specs (í•„ìˆ˜): "Shot on iPhone 15 Pro, 4k vertical footage, stable footage, sharp focus, high resolution, highly detailed, crystal clear"
2. Lighting: "Natural window light", "Soft bright clinic lighting", "Clean daylight", "No harsh shadows"
3. Atmosphere: "Professional", "Clean", "Modern", "Peaceful", "Trustworthy", "Korean clinic setting"
4. Subject Focus:
   - ì¸ë¬¼ë³´ë‹¤ëŠ” "ê³µê°„, ì‚¬ë¬¼, ë¶„ìœ„ê¸°" ìœ„ì£¼ë¡œ ë¬˜ì‚¬ (AIê°€ ì¸ë¬¼ í‘œì •ì„ ì™œê³¡í•˜ëŠ” ê²ƒ ë°©ì§€)
   - ì¸ë¬¼ ë“±ì¥ ì‹œ: ë’·ëª¨ìŠµ, ì‹¤ë£¨ì—£, ì† ë™ì‘, ë§ˆìŠ¤í¬ ì°©ìš© ë“± ë””í…Œì¼ì´ ì ì€ ìƒ· ê¶Œì¥
5. "no text, no titles, no captions" (ê¸€ì ìƒì„± ê¸ˆì§€!)

ã€ì£¼ì œë³„ ì—°ì¶œ ê°€ì´ë“œ (ì•ˆì •ì„± ìœ„ì£¼)ã€‘
- ì•ˆê³¼: ê¹¨ë—í•˜ê³  ë°ì€ ì•ˆê³¼ ë‚´ë¶€ ì „ê²½, ìµœì‹  ê²€ì‚¬ ì¥ë¹„ì˜ ë””í…Œì¼í•œ ëª¨ìŠµ, ì•ˆê²½ì„ í…Œì´ë¸”ì— ë†“ëŠ” ì† í´ë¡œì¦ˆì—…
- í”¼ë¶€ê³¼: ê¹¨ë—í•œ ì„¸ì•ˆì‹¤, ê³ ê¸‰ìŠ¤ëŸ¬ìš´ ìŠ¤í‚¨ì¼€ì–´ ì œí’ˆ ì§„ì—´, ë§‘ê³  íˆ¬ëª…í•œ í”¼ë¶€ í…ìŠ¤ì²˜(ì´ëª©êµ¬ë¹„ ì œì™¸)
- ì„±í˜•ì™¸ê³¼: ëª¨ë˜í•˜ê³  í”„ë¼ì´ë¹—í•œ ìƒë‹´ì‹¤ ì¸í…Œë¦¬ì–´, í¸ì•ˆí•œ ì†ŒíŒŒ, ë°ì€ ì°½ê°€ í’ê²½
- í†µì¦ì˜í•™ê³¼: ê¹”ë”í•œ ë¬¼ë¦¬ì¹˜ë£Œì‹¤ ì¹¨ëŒ€, ì •ëˆëœ ì˜ë£Œ ê¸°êµ¬, ë”°ëœ»í•œ ì°œì§ˆíŒ© ì´ë¯¸ì§€
- ì¹˜ê³¼: ìœ„ìƒì ì¸ ì¹˜ê³¼ ì²´ì–´, ë°ì€ ì¡°ëª… ì•„ë˜ ë°˜ì§ì´ëŠ” ì¹˜ê³¼ ë„êµ¬, ê¹¨ë—í•œ ì¹«ì†”/ì¹˜ì•½

ã€í”„ë¡¬í”„íŠ¸ í˜•ì‹ ì˜ˆì‹œã€‘
"Montage of modern clinic atmosphere: [ì¥ë©´1 - Interior], [ì¥ë©´2 - Equipment], [ì¥ë©´3 - Hand detail]. Shot on iPhone 15 Pro, 4k vertical, stable footage, natural daylight, clean white aesthetic, Korean hospital background, sharp focus, high quality, no text, no titles"

âŒ ì ˆëŒ€ ê¸ˆì§€ (Negative Constraints):
- CGI, 3D render, Unreal Engine, video game graphics
- Distorted face, morphing, blurry, bad anatomy, scary, creepy
- Complex camera movement, fast zoom, shaky camera
- Selfie, extreme close-up of eyes/mouth (ê¸°ê´´í•¨ ìœ ë°œ ì›ì¸)
- Text, subtitles, watermarks
- (ë¶ˆì¾Œí•˜ê±°ë‚˜ ì™œê³¡ëœ ì´ë¯¸ì§€ ì ˆëŒ€ ê¸ˆì§€!)

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
ã€ì¶œë ¥ í˜•ì‹ (JSON)ã€‘
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

{
  "videoPrompts": [
    {
      "order": 0,
      "prompt": "í´ë¦½1ìš© ì˜ë¬¸ í”„ë¡¬í”„íŠ¸ (í›… ì¥ë©´, 600ì+)"
    },
    {
      "order": 1,
      "prompt": "í´ë¦½2ìš© ì˜ë¬¸ í”„ë¡¬í”„íŠ¸ (ì •ë³´ ì¥ë©´, 600ì+)"
    },
    {
      "order": 2,
      "prompt": "í´ë¦½3ìš© ì˜ë¬¸ í”„ë¡¬í”„íŠ¸ (CTA ì¥ë©´, 600ì+)"
    }
  ]
}`;

    console.log(`[ShortsDebug] Video Generation Prompt to AI:\n${prompt}`);

    const response = await this.callAI(prompt);
    const promptsResult = JSON.parse(response) as {
      videoPrompts: { order: number; prompt: string }[];
    };

    console.log(`[ShortsDebug] Raw AI Response for Video Prompts:`, JSON.stringify(promptsResult, null, 2));

    // ëŒ€ë³¸ê³¼ í”„ë¡¬í”„íŠ¸ ê²°í•©
    const segments: ShortSegment[] = scriptDraft.segments.map((seg) => {
      const videoPromptData = promptsResult.videoPrompts.find(
        (p) => p.order === seg.order
      );
      return {
        ...seg,
        videoPrompt: videoPromptData?.prompt || '',
      };
    });

    return {
      shortsTitle: scriptDraft.shortsTitle,
      summary: scriptDraft.summary,
      segments,
      totalDuration: 24,
    };
  }

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // AI í˜¸ì¶œ í—¬í¼
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  private async callAI(prompt: string): Promise<string> {
    try {
      const response = await this.openai.chat.completions.create({
        model: 'gpt-5-mini',
        messages: [
          {
            role: 'system',
            content: 'You are an expert viral shorts content creator. Always respond in valid JSON format.',
          },
          {
            role: 'user',
            content: prompt,
          },
        ],
        response_format: { type: 'json_object' },
      });

      const content = response.choices[0]?.message?.content;
      if (!content) {
        throw new Error('AI ì‘ë‹µì´ ë¹„ì–´ìˆìŠµë‹ˆë‹¤.');
      }

      return content;
    } catch (error: any) {
      if (error instanceof SyntaxError) {
        throw new Error('AI ì‘ë‹µì„ íŒŒì‹±í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.');
      }
      throw error;
    }
  }
}
